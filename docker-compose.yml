services:
  postgres:
    image: postgres:16-alpine
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-ios_backup_user}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-change_me_in_production}
      POSTGRES_DB: ${POSTGRES_DB:-ios_backup_explorer}
    volumes:
      - pg_data:/var/lib/postgresql/data
    ports:
      - "${IOS_BACKUP_POSTGRES_HOST_IP:-127.0.0.1}:${IOS_BACKUP_POSTGRES_HOST_PORT:-5432}:5432"
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  redis:
    image: redis:7-alpine
    command: redis-server --requirepass ${REDIS_PASSWORD:-change_me_in_production}
    ports:
      - "${IOS_BACKUP_REDIS_HOST_IP:-127.0.0.1}:${IOS_BACKUP_REDIS_HOST_PORT:-6379}:6379"
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  backend:
    build:
      context: .
      dockerfile: Dockerfile.backend
    environment:
      APPLE_JUICER_SECURITY__API_TOKEN: ${APPLE_JUICER_API_TOKEN:-dev-token}
      APPLE_JUICER_SECURITY__TRUSTED_HOSTS__0: http://localhost:${APPLE_JUICER_FRONTEND_HOST_PORT:-5173}
      APPLE_JUICER_SECURITY__TRUSTED_HOSTS__1: http://127.0.0.1:${APPLE_JUICER_FRONTEND_HOST_PORT:-5173}
      APPLE_JUICER_POSTGRES__DSN: postgresql+asyncpg://${POSTGRES_USER:-apple_juicer_user}:${POSTGRES_PASSWORD:-change_me_in_production}@postgres:5432/${POSTGRES_DB:-apple_juicer}
      APPLE_JUICER_REDIS__URL: redis://:${REDIS_PASSWORD:-change_me_in_production}@redis:6379/0
      APPLE_JUICER_BACKUP_PATHS__BASE_PATH: /data/ios_backups
      APPLE_JUICER_BACKUP_PATHS__TEMP_PATH: /tmp/apple_juicer
      APPLE_JUICER_BACKUP_PATHS__DECRYPTED_PATH: /data/decrypted_backups
      APPLE_JUICER_BACKUP_PATHS__HOST_DISPLAY_PATH: ${APPLE_JUICER_BACKUP_HOST_PATH:-/data/ios_backups}
      APPLE_JUICER_VERSION: ${APPLE_JUICER_VERSION:-0.1.0}
      APPLE_JUICER_ENVIRONMENT: ${APPLE_JUICER_ENVIRONMENT:-development}
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
    volumes:
      - ${APPLE_JUICER_BACKUP_HOST_PATH:-./data/ios_backups}:/data/ios_backups:ro
      - ${APPLE_JUICER_DECRYPTED_HOST_PATH:-./data/decrypted_backups}:/data/decrypted_backups
    ports:
      - "${APPLE_JUICER_BACKEND_HOST_IP:-0.0.0.0}:${APPLE_JUICER_BACKEND_HOST_PORT:-8080}:8080"
    depends_on:
      - postgres
      - redis
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "5"

  worker:
    build:
      context: .
      dockerfile: Dockerfile.backend
    command: ["rq", "worker", "default", "--url", "redis://:${REDIS_PASSWORD:-change_me_in_production}@redis:6379/0"]
    environment:
      APPLE_JUICER_SECURITY__API_TOKEN: ${APPLE_JUICER_API_TOKEN:-dev-token}
      APPLE_JUICER_POSTGRES__DSN: postgresql+asyncpg://${POSTGRES_USER:-apple_juicer_user}:${POSTGRES_PASSWORD:-change_me_in_production}@postgres:5432/${POSTGRES_DB:-apple_juicer}
      APPLE_JUICER_REDIS__URL: redis://:${REDIS_PASSWORD:-change_me_in_production}@redis:6379/0
      APPLE_JUICER_BACKUP_PATHS__BASE_PATH: /data/ios_backups
      APPLE_JUICER_BACKUP_PATHS__TEMP_PATH: /tmp/apple_juicer
      APPLE_JUICER_BACKUP_PATHS__DECRYPTED_PATH: /data/decrypted_backups
      APPLE_JUICER_BACKUP_PATHS__HOST_DISPLAY_PATH: ${APPLE_JUICER_BACKUP_HOST_PATH:-/data/ios_backups}
      APPLE_JUICER_VERSION: ${APPLE_JUICER_VERSION:-0.1.0}
      APPLE_JUICER_ENVIRONMENT: ${APPLE_JUICER_ENVIRONMENT:-development}
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
    volumes:
      - ${APPLE_JUICER_BACKUP_HOST_PATH:-./data/ios_backups}:/data/ios_backups:ro
      - ${APPLE_JUICER_DECRYPTED_HOST_PATH:-./data/decrypted_backups}:/data/decrypted_backups
    depends_on:
      - postgres
      - redis
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "5"

  frontend:
    build:
      context: .
      dockerfile: Dockerfile.frontend
      args:
        VITE_API_BASE_URL: /api
        VITE_APP_VERSION: ${APPLE_JUICER_VERSION:-0.1.0}
    ports:
      - "${APPLE_JUICER_FRONTEND_HOST_IP:-0.0.0.0}:${APPLE_JUICER_FRONTEND_HOST_PORT:-5173}:80"
    depends_on:
      - backend
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

volumes:
  pg_data:
